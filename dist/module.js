define(["react","@grafana/ui","@grafana/data","@grafana/runtime","moment"],(function(e,t,n,r,o){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=o},function(e,t,n){"use strict";n.r(t);var r,o,a,i,s,u=n(2),c=n(0),l=n.n(c),p=n(1),f=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),d=function(){return(d=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},h=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))},g=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},v=/code=([\w]+)/,y=function(e){function t(n){var r=e.call(this,n)||this;r.updateDatasource=function(e){return h(r,void 0,void 0,(function(){var t,n;return g(this,(function(r){for(t in e.jsonData)0===e.jsonData[t].length&&delete e.jsonData[t];for(n in e.secureJsonData)0===e.secureJsonData[n].length&&delete e.secureJsonData[n];return this.props.onOptionsChange(d({},e)),[2]}))}))},r.onResetAccessToken=function(){r.updateDatasource(d(d({},r.state.config),{secureJsonFields:d(d({},r.state.config.secureJsonFields),{accessToken:!1})}))},r.onResetClientSecret=function(){r.updateDatasource(d(d({},r.state.config),{secureJsonFields:d(d({},r.state.config.secureJsonFields),{clientSecret:!1})}))},r.onResetAuthCode=function(){r.updateDatasource(d(d({},r.state.config),{secureJsonFields:d(d({},r.state.config.secureJsonFields),{authCode:!1})}))},r.onAccessTokenChange=function(e){r.updateDatasource(d(d({},r.state.config),{secureJsonData:d(d({},r.state.config.secureJsonData),{accessToken:e})}))},r.onClientIDChange=function(e){r.updateDatasource(d(d({},r.state.config),{jsonData:d(d({},r.state.config.jsonData),{clientID:e})}))},r.onClientSecretChange=function(e){r.updateDatasource(d(d({},r.state.config),{secureJsonData:d(d({},r.state.config.secureJsonData),{clientSecret:e})}))},r.onAuthCodeChange=function(e){r.updateDatasource(d(d({},r.state.config),{secureJsonData:d(d({},r.state.config.secureJsonData),{authCode:e})}))},r.isLocationContainsCode=function(){return v.test(window.location.search)},r.isLocationContainsError=function(){return/error=/.test(window.location.search)},r.fillAuthCodeFromLocation=function(){var e=v.exec(window.location.search),t=e&&e.length&&e[1];r.updateDatasource(d(d({},r.state.config),{secureJsonData:d(d({},r.state.config.secureJsonData),{authCode:t})}))},r.getConnectHref=function(){var e=window.location.origin+window.location.pathname;return"https://accounts.airthings.com/authorize?client_id="+r.state.config.jsonData.clientID+"&response_type=code&redirect_uri="+e+"&scope=read:device"};var o=r.props.options;return r.state={config:t.defaults(o)},r.updateDatasource(r.state.config),r}return f(t,e),t.getDerivedStateFromProps=function(e,n){return d(d({},n),{config:t.defaults(e.options)})},t.prototype.render=function(){var e=this,t=this.state.config,n=this.getConnectHref();return l.a.createElement(l.a.Fragment,null,l.a.createElement("h3",{className:"page-heading"},"Airthings API Details"),l.a.createElement("div",{className:"gf-form-group"},l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement("div",{className:"gf-form"},l.a.createElement(p.FormLabel,{className:"width-14"},"Client ID"),l.a.createElement("div",{className:"width-30"},l.a.createElement(p.Input,{className:"width-30",value:t.jsonData.clientID||"",onChange:function(t){return e.onClientIDChange(t.target.value)}})))),t.secureJsonFields.clientSecret?l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement("div",{className:"gf-form"},l.a.createElement(p.FormLabel,{className:"width-14"},"Client Secret"),l.a.createElement(p.Input,{className:"width-25",placeholder:"Configured",disabled:!0})),l.a.createElement("div",{className:"gf-form"},l.a.createElement("div",{className:"max-width-30 gf-form-inline"},l.a.createElement(p.Button,{variant:"secondary",type:"button",onClick:this.onResetClientSecret},"Reset")))):l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement("div",{className:"gf-form"},l.a.createElement(p.FormLabel,{className:"width-14"},"Client Secret"),l.a.createElement("div",{className:"width-30"},l.a.createElement(p.Input,{className:"width-30",value:t.secureJsonData.clientSecret||"",onChange:function(t){return e.onClientSecretChange(t.target.value)}}))))),l.a.createElement("div",{className:"gf-form-group"},l.a.createElement("a",{type:"button",href:n},l.a.createElement("img",{src:"public/plugins/grafana-airthings-datasource/img/connect-logo.svg"}))))},t.defaults=function(e){return e.hasOwnProperty("secureJsonData")||(e.secureJsonData={}),e.hasOwnProperty("jsonData")||(e.jsonData={}),e.hasOwnProperty("secureJsonFields")||(e.secureJsonFields={}),e},t}(c.PureComponent);!function(e){e.TimeSeries="time_series",e.Table="table",e.WorldMap="worldmap"}(o||(o={})),function(e){e.Full="",e.Hour="HOUR",e.Day="DAY",e.Week="WEEK"}(a||(a={})),function(e){e.Devices="Devices",e.Locations="Locations"}(i||(i={})),function(e){e.Temp="temp",e.Radon="radonShortTermAvg",e.Humidity="humidity",e.Pressure="pressure",e.TVOC="voc",e.CO2="co2",e.Light="light",e.All="all"}(s||(s={}));var m=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),b=function(){return(b=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},w=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))},O=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},S=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var a=arguments[t],i=0,s=a.length;i<s;i++,o++)r[o]=a[i];return r},C=[{value:i.Devices,label:"Devices",description:"Device Sample Data"}],T=[{value:s.All,label:"All"},{value:s.Radon,label:"Radon"},{value:s.CO2,label:"Co2"},{value:s.TVOC,label:"TVOC"},{value:s.Temp,label:"Temp"},{value:s.Humidity,label:"Humidity"},{value:s.Pressure,label:"Pressure"},{value:s.Light,label:"Light"}],I=[{label:"Time series",value:o.TimeSeries}],D=[{label:"Full",value:a.Full},{label:"Hour",value:a.Hour},{label:"Day",value:a.Day},{label:"Week",value:a.Week}],q={refId:"",organizations:[],devices:[],locations:[],queryType:i.Devices,sensorType:s.Temp,resourceId:null,locationId:null,organizationId:null,resourceName:"",format:o.TimeSeries,resolution:a.Hour},x=function(e){function t(t){var n=e.call(this,t)||this;return n.state=q,n.queryDefaults={refId:null,resourceName:"",format:o.TimeSeries,queryType:i.Devices,resourceId:null,locationId:null,organizationId:null,sensorType:s.Temp,resolution:a.Hour},n.getQueryTypeOption=function(){return C.find((function(e){return e.value===n.props.query.queryType}))},n.getOrganizationOption=function(){return n.state.organizations.find((function(e){return e.value===n.props.query.organizationId}))},n.getResource=function(e){if(null===e)return null;var t=n.props.query.queryType===i.Locations?n.state.locations:n.state.devices;return t?t.find((function(t){return t.value===e})):null},n.getLocationOption=function(){return n.state.locations.find((function(e){return e.value===n.props.query.locationId}))},n.getAvaliableLocationOptions=function(){return n.state.locations},n.getAvaliableResourceOptions=function(){return n.props.query.queryType===i.Locations?n.state.locations:n.state.devices.filter((function(e){return e.locationId===n.props.query.locationId}))},n.getResourceOption=function(){return n.getResource(n.props.query.resourceId)},n.getSensorsOfSelectedResource=function(){if(n.props.query.queryType===i.Locations)return T;var e=n.getResourceOption(),t=e?e.sensors+s.All:[],r=e?e.sensors.filter((function(e){return-1===T.map((function(e){return e.value})).indexOf(e)})):[],o=T.filter((function(e){return t.includes(e.value)})),a=S(o,r.map((function(e){return{value:e,label:e}})));return a||[]},n.getSensorTypeOption=function(){return n.getSensorsOfSelectedResource().find((function(e){return e.value===n.props.query.sensorType}))},n.getFormatOption=function(){return I.find((function(e){return e.value===n.props.query.format}))},n.getResolutionOption=function(){return D.find((function(e){return e.value===n.props.query.resolution}))},n.onLocationChanged=function(e){var t=n.props.query;n.onChange(b(b({},t),{locationId:e.value,resourceId:null}))},n.onQueryTypeChanged=function(e){var t=n.props.query;n.onChange(b(b({},t),{queryType:e.value,resourceId:null,sensorType:null}))},n.onResourceChanged=function(e){var t=n.props.query;n.onChange(b(b({},t),{resourceId:e.value,resourceName:n.getResource(e.value).label}))},n.onSensorTypeChanged=function(e){var t=n.props.query;n.onChange(b(b({},t),{sensorType:e.value}))},n.onOrganizationChanged=function(e){var t=n.props.query;n.onChange(b(b({},t),{organizationId:e.value,locationId:null,resourceId:null})),n.getResourcesForOrganization(e.value)},n.onFormatChange=function(e){var t=n.props.query;n.onChange(b(b({},t),{format:e.value}))},n.onResolutionChange=function(e){var t=n.props.query;n.onChange(b(b({},t),{resolution:e.value}))},n}return m(t,e),t.prototype.componentDidMount=function(){return w(this,void 0,void 0,(function(){var e,t,n,r=this;return O(this,(function(o){switch(o.label){case 0:return[4,this.props.datasource.airthingsApi.getOrganizations()];case 1:return e=o.sent(),t=e.organizations.map((function(e){return{value:e.id,label:e.name,description:e.id}})),this.setState({organizations:t}),n=t.find((function(e){return e.value===r.props.query.organizationId}))?this.props.query.organizationId:null,[4,this.getResourcesForOrganization(n)];case 2:return o.sent(),this.onChange(b(b({},this.props.query),{queryType:this.queryDefaults.queryType})),[2]}}))}))},t.prototype.getResourcesForOrganization=function(e){return w(this,void 0,void 0,(function(){var t,n,r,o;return O(this,(function(a){switch(a.label){case 0:return e=e||this.props.query.organizationId,[4,this.props.datasource.airthingsApi.getDevices({organizationId:e})];case 1:return t=a.sent(),n=t.devices.map((function(e){return{value:e.id,label:e.segment.name,description:e.id,sensors:e.sensors,locationId:e.location.id}})),[4,this.props.datasource.airthingsApi.getLocations({organizationId:e})];case 2:return r=a.sent(),o=r.locations.map((function(e){return{value:e.id,label:e.name,description:e.id}})),this.setState({devices:n,locations:o}),[2]}}))}))},t.prototype.onChange=function(e){var t=this.props,n=t.onChange,r=t.onRunQuery;n(e),r()},t.prototype.render=function(){var e=this.state.organizations;return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement(p.FormLabel,{width:10},"Organization"),l.a.createElement(p.Select,{isSearchable:!1,width:15,value:this.getOrganizationOption(),options:e,onChange:this.onOrganizationChanged,className:"gf-form-select"}),C.length>1&&l.a.createElement("span",null,l.a.createElement(p.FormLabel,{width:10},"Type"),l.a.createElement(p.Select,{isSearchable:!1,width:10,value:this.getQueryTypeOption(),options:C,onChange:this.onQueryTypeChanged,className:"gf-form-select"})),l.a.createElement(p.FormLabel,{width:10},"Location"),l.a.createElement(p.Select,{isSearchable:!1,width:10,value:this.getLocationOption(),options:this.getAvaliableLocationOptions(),onChange:this.onLocationChanged,className:"gf-form-select"})),l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement(p.FormLabel,{width:10},this.props.query.queryType===i.Locations?"Location":"Device"),l.a.createElement(p.Select,{isSearchable:!1,width:15,value:this.getResourceOption(),options:this.getAvaliableResourceOptions(),onChange:this.onResourceChanged,className:"gf-form-select"}),l.a.createElement(p.FormLabel,{width:10},"Sensor"),l.a.createElement(p.Select,{isSearchable:!1,width:10,value:this.getSensorTypeOption(),options:this.getSensorsOfSelectedResource(),onChange:this.onSensorTypeChanged,className:"gf-form-select"})),l.a.createElement("div",{className:"gf-form-inline"},l.a.createElement(p.FormLabel,{width:10},"Format"),l.a.createElement(p.Select,{isSearchable:!1,width:15,options:I,onChange:this.onFormatChange,value:this.getFormatOption()}),l.a.createElement(p.FormLabel,{width:10},"Resolution"),l.a.createElement(p.Select,{isSearchable:!1,width:10,options:D,onChange:this.onResolutionChange,value:this.getResolutionOption()})))},t}(c.PureComponent),_=n(3),E=function(){return(E=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},R=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))},A=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},z=function(){function e(e){this.datasourceId=e,this.promises={}}return e.prototype.getLocationLatestSamples=function(e){return R(this,void 0,void 0,(function(){return A(this,(function(t){switch(t.label){case 0:return e.organizationId?"locations/"+e.resourceId+"/latest-samples?organizationId="+e.organizationId:"locations/"+e.resourceId+"/latest-samples",[4,this.requestWithPagination("locations/"+e.resourceId+"/latest-samples",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getDeviceSamples=function(e){return R(this,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return t=e.organizationId?"devices/"+e.resourceId+"/samples?resolution="+e.resolution+"?organizationId="+e.organizationId:"devices/"+e.resourceId+"/samples?resolution="+e.resolution,[4,this.tsdbRequest(t,e)];case 1:return[2,n.sent()]}}))}))},e.prototype.getOrganizations=function(e){return R(this,void 0,void 0,(function(){return A(this,(function(t){switch(t.label){case 0:return[4,this.tsdbRequest("organizations",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getDevices=function(e){return R(this,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return t=e.organizationId?"devices?organizationId="+e.organizationId:"devices",[4,this.tsdbRequest(t,e)];case 1:return[2,n.sent()]}}))}))},e.prototype.getLocations=function(e){return R(this,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return t=e.organizationId?"locations?organizationId="+e.organizationId:"locations",[4,this.tsdbRequest(t,e)];case 1:return[2,n.sent()]}}))}))},e.prototype.requestWithPagination=function(e,t){return R(this,void 0,void 0,(function(){var n,r,o,a,i;return A(this,(function(s){switch(s.label){case 0:n=[],r=[],o=1,a=t&&t.limit,i=t&&t.per_page||200,s.label=1;case 1:if(0===r.length&&1!==o||a&&n.length>=a)return[3,6];t=E(E({},t),{per_page:i,page:o}),s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this.tsdbRequest(e,t)];case 3:return r=s.sent(),[3,5];case 4:throw s.sent();case 5:return n=n.concat(r),o++,[3,1];case 6:return[2,n]}}))}))},e.prototype.exchangeToken=function(e){return R(this,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return t=window.location.origin+window.location.pathname,[4,this.tsdbAuthRequest({authCode:e,redirectUri:t})];case 1:return[2,n.sent()]}}))}))},e.prototype.tsdbRequest=function(e,t){return R(this,void 0,void 0,(function(){return A(this,(function(n){return[2,this.proxyfy(this._tsdbRequest,"_tsdbRequest",this)(e,t)]}))}))},e.prototype._tsdbRequest=function(e,t){return R(this,void 0,void 0,(function(){var n,r,o;return A(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),n={queries:[{datasourceId:this.datasourceId,queryType:"airthingsApi",target:{endpoint:e,params:t}}]},[4,Object(_.getBackendSrv)().datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n})];case 1:return r=a.sent(),[2,this.handleTsdbResponse(r)];case 2:throw o=a.sent(),console.log(o),o;case 3:return[2]}}))}))},e.prototype.tsdbAuthRequest=function(e){return R(this,void 0,void 0,(function(){var t,n,r,o;return A(this,(function(a){switch(a.label){case 0:t="airthingsAuth",n={queries:[{datasourceId:this.datasourceId,queryType:t,target:{params:e}}]},a.label=1;case 1:return a.trys.push([1,3,,4]),[4,Object(_.getBackendSrv)().datasourceRequest({url:"/api/tsdb/query",method:"POST",data:n})];case 2:return r=a.sent(),[2,this.handleTsdbResponse(r,t)];case 3:throw o=a.sent(),console.log(o),o;case 4:return[2]}}))}))},e.prototype.handleTsdbResponse=function(e,t){if(void 0===t&&(t="airthingsApi"),e&&(e.status>=400||e.status<0))throw Error(e.statusText);if(!e||!e.data||!e.data.results)return[];var n=e.data.results[t];if(n.error)throw Error(n.error);return n.meta},e.prototype.proxyfy=function(e,t,n){return this.promises[t]||(this.promises[t]={}),function(e,t,n){return function(){var r=L(arguments);return t[r]||(t[r]=Promise.resolve(e.apply(n,arguments).then((function(e){return t[r]=null,e})))),t[r]}}(e,this.promises[t],n)},e}();function L(e){return function(e){var t,n,r,o=0;if(0!==e.length)for(t=0,r=e.length;t<r;t++)n=e.charCodeAt(t),o=(o<<5)-o+n,o|=0;return o}(JSON.stringify(e))}var j=1e5;function N(e){return 1&e?~(e>>>1):e>>>1}var F={decode:function(e){var t=[],n=0,r=0;return function(e,t){for(var n=0,r=0,o=0,a=0,i=0,s=0,u=0;u<e.length;u++)a=e.charCodeAt(u)-63,i|=(31&a)<<s,s+=5,a<32&&(1&++n?r=N(i):(o=N(i),t(r,o)),i=0,s=0)}(e,(function(e,o){n+=e,r+=o,t.push([n/j,r/j])})),t}},P=(n(4),function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}()),k=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))},J=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},H=function(e,t){return e.map((function(e,n){return[e,t[n]]}))},M=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.templateSrv=n,o.timeSrv=r,o.type="airthings",o.datasourceId=t.id,o.apiUrl=t.url,o.airthingsApi=new z(o.datasourceId),o}return t.$inject=["instanceSettings","templateSrv","timeSrv"],P(t,e),t.prototype.parseSelectedSensorSamples=function(e,t){var n=[],r=t.data.time.map((function(e){return 1e3*e}));delete t.data.time;for(var o=0,a=e.sensorType===s.All?Object.keys(t.data):[e.sensorType];o<a.length;o++){var i=a[o],u=t.data[i];n.push({target:e.resourceName+" - "+i,datapoints:H(u,r)})}return n},t.prototype.query=function(e){return k(this,void 0,void 0,(function(){var t,n,r,o,a,s,u,c,l,p,f;return J(this,(function(d){switch(d.label){case 0:t=[],n=0,r=e.targets,d.label=1;case 1:if(!(n<r.length))return[3,7];if(null===(o=r[n]).queryType||null===o.resourceId||null===o.sensorType)return[3,6];switch(o.queryType){case i.Devices:return[3,2];case i.Locations:return[3,4]}return[3,6];case 2:return a={resourceId:o.resourceId,resourceName:o.resourceName,resolution:o.resolution,sensorType:o.sensorType,start:e.range.from.unix(),end:e.range.to.unix},[4,this.airthingsApi.getDeviceSamples(a)];case 3:for(s=d.sent(),u=this.parseSelectedSensorSamples(a,s),c=0,l=u;c<l.length;c++)p=l[c],t.push(p);return[3,6];case 4:return[4,this.airthingsApi.getLocationLatestSamples({resourceId:o.resourceId,sensorType:o.sensorType,resourceName:o.resourceName,start:e.range.from.unix(),end:e.range.to.unix})];case 5:return f=d.sent(),t.push(f),[3,6];case 6:return n++,[3,1];case 7:return[2,{data:t}]}}))}))},t.prototype.testDatasource=function(){return k(this,void 0,void 0,(function(){var e,t;return J(this,(function(n){switch(n.label){case 0:if(!(e=this.getAuthCode()))return[3,4];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.airthingsApi.exchangeToken(e)];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),console.log(t),[3,4];case 4:return n.trys.push([4,6,,7]),[4,this.airthingsApi.getOrganizations({per_page:2,limit:2})];case 5:return n.sent(),[2,{status:"success",message:"Data source is working"}];case 6:return n.sent(),[2,{status:"error",message:"Cannot connect to Airthings API"}];case 7:return[2]}}))}))},t.prototype.getAuthCode=function(){var e=/code=([A-Za-z0-9\-]+)/.exec(window.location.search),t=e&&e.length&&e[1];return null===t&&console.log("failed to get auth code :("),t},t.prototype.filterActivities=function(e,t){return t?e.filter((function(e){return t===s.All?"Run"!==e.type&&"Ride"!==e.type:e.type===t})):e},t.prototype.transformActivitiesToTable=function(e,t){for(var n={type:"table",columns:[{text:"Time"},{text:"name"},{text:"distance",unit:"lengthm"},{text:"moving_time",unit:"s"},{text:"elapsed_time",unit:"s"},{text:"total_elevation_gain",unit:"lengthm"},{text:"type"},{text:"kilojoules",unit:"joule"}],rows:[]},r=0,o=e;r<o.length;r++){var a=o[r],i=[Object(u.dateTime)(a.start_date),a.name,a.distance,a.moving_time,a.elapsed_time,a.total_elevation_gain,a.type,a.kilojoules];n.rows.push(i)}return n},t.prototype.transformActivitiesToWorldMap=function(e,t){for(var n={type:"table",columns:[{text:"value",unit:null},{text:"name"},{text:"latitude"},{text:"longitude"}],rows:[]},r=0,o=e;r<o.length;r++){var a=o[r],i=Q(a),s=i?i[0]:a.start_latitude,u=i?i[1]:a.start_longitude,c=[a[t.resourceId],a.name,s,u];a.start_latitude&&a.start_longitude&&n.rows.push(c)}return n},t}(u.DataSourceApi);function Q(e){if(!e.map||!e.map.summary_polyline)return null;var t=e.map.summary_polyline,n=F.decode(t);return n&&n.length?n[Math.floor(n.length/2)]:null}n.d(t,"plugin",(function(){return G}));var W=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),G=new u.DataSourcePlugin(M).setConfigEditor(y).setQueryEditor(x).setExploreQueryField(x).setAnnotationQueryCtrl(W)}])}));